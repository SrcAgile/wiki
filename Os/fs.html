<!DOCTYPE HTML>
<html>
  <head>
    <link rel="Stylesheet" type="text/css" href="/wiki/static/css/style.css">
    <link rel="Stylesheet" type="text/css" href="/wiki/static/css/tango.css">
    <link rel="alternate" type="application/atom+xml" href="atom.xml" title="Atom feed">
    <link rel="shortcut icon" href="/wiki/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/wiki/favicon.ico" type="image/x-icon">
    <link rel="alternate" type="application/atom+xml" href="atom.xml" title="Atom feed">
    <script type="text/x-mathjax-config">
       MathJax.Hub.Config({
         tex2jax: {inlineMath: [['$(',')$'], ['\\(','\\)']]}
       });
    </script>
    <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <title>文件系统原理 - Meta's Wiki</title>
    <meta name="keywords" content=""/>
    <meta name="description" content=""/>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  </head>

  <body>
    <div id="container">
      
<div id="header">
  <div class="post-nav"><a href="/wiki/">Home</a>&nbsp;&#187;&nbsp;<a href="/wiki/#Os">Os</a>&nbsp;&#187;&nbsp;文件系统原理
    <span class="updated">Page Updated&nbsp;
      2018-01-08 21:00:00
    </span></div>
</div>
<div class="clearfix"></div>

<div class="page_title">文件系统原理</div>

  <p><strong>文档状态：</strong><a style="color:red;background-color:gray">编辑中....</a></p>
<hr />
<blockquote></blockquote>
<hr />
<ul>
<li><strong>今日音乐</strong></li>
</ul>
<div class="hlcode"><pre><span class="p">[</span><span class="err">网评</span><span class="p">]</span>
</pre></div>


<h3 id="_1">设计</h3>
<ol>
<li>
<p>文件系统使用者的特征是什么？大文件居多还是小文件居多？如果基本都是大文件应用，那么数据块可以做的大一点，使得元数据信息少点，减少这方面的开销。<br />
<code>例如淘宝的TFS集群文件系统，由于系统前端采用了大量的缓存，从而使得TFS的输入全是大文件，因此可以采用大文件设计思想对其进行优化,可以减少目录层次，这样在检索一个文件的时候，不需要花费太多的时间，这种处理可以提升系统性能。</code></p>
</li>
<li>
<p>文件系统是读应用为主还是写应用为主？这点也是很重要的，如果是写为主的应用，那么可以采用log structured的方式优化IO pattern<br />
<code>例如在备份系统中，基本都是以写请求，那么对于这样的系统，可以采用log structured的方式使得底层IO更加顺序化。</code></p>
</li>
<li>
<p>文件系统的可扩展性，其中包括随着磁盘容量的增长，文件系统是否可以无缝扩展？<br />
<code>例如以前的FAT文件系统由于元数据的限制，对支持的容量有着很强的限制。而中科蓝鲸的BWFS元数据和数据IO流分离,可以达到很高的集群性能,但是，这种架构也有一个问题，当应用文件以小文件为主的时候，元数据服务器会成为整个系统的性能瓶颈。因为局部性原理,并且元数据与数据分开写致使出现抖动现象.所以可以对元数据进行缓存.</code></p>
</li>
<li>
<p>数据在磁盘上如何布局？数据在磁盘上的不同布局会对文件系统的性能产生很大的影响。<br />
<code>如果元数据信息离数据很远，那么一次写操作将会导致剧烈的磁盘抖动。EXT3将整个磁盘空间划分成多个块组让元数据与数据信息离得很近</code></p>
</li>
<li>
<p>数据安全性如何保证？如果文件系统的元数据遭到了破坏，如何恢复文件数据？如果用户误删了文件，如何恢复用户的数据？这些都需要文件系统设计者进行仔细设计。</p>
</li>
<li>
<p>如何保证操作事务的一致性？对于一次写操作设计到元数据更新和文件数据的更新，这两者之间的操作次序如何设计？既能保证很好的性能，又能在系统crash的时候保证文件系统的一致性？在很多设计中采用数据先于元数据的方式，并且通过日志机制保证事务一致性。</p>
</li>
<li>
<p>文件系统元数据占用多少系统内存？如果一个文件系统占用太多的系统内存，那么会影响整个系统的性能</p>
</li>
</ol>
<h3 id="messy">messy</h3>
<h3 id="_2">文件访问控制的演变</h3>
<ul>
<li>访问类型<br />
需要<b> 控制访问（controlled access）</b> 来限制可以进行的文件访问类型，访问类型包括：<b>读、写、执行、添加、删除、列表清单（获取文件名称、属性等）<b>。更多操作（重命名、编辑等）都是这些底层操作的组合，因此保护只需要在底层提供，高层操作涉及的底层操作如果不满足保护的要求就会被拒绝。</li>
</ul>
<h4 id="_3">访问策略</h4>
<ol>
<li>
<p>添加ACL(access-control list)即访问控制列表</p>
<ul>
<li>优:自主选择让谁用,不让谁用</li>
<li>缺:需事先知道系统的用户列表,且列表长度会扩大</li>
<li>应用范围:用户数量较少且固定已知身份id的系统 比如(局域网络系统)</li>
</ul>
</li>
<li>
<p>用户组控制</p>
<ul>
<li>优:用户多时方便统一授权,不必每个用户单独设置访问权限</li>
<li>缺:不能说有缺点吧</li>
<li>局限:需要联合用户授权机制使用,系统应该提供用户默认的用户组</li>
<li>应用范围:大量用户,需要对数据严格控制的系统.比如:(数据库管理系统)</li>
</ul>
</li>
</ol>
<h3 id="superblock">superblock</h3>
<blockquote>
<p>对于ex系列文件系统来说，存储在分区的第二个block(令一个大小为1k)，平时的时候为了提高检索速度，这个元信息会加载到内存中，让我们观察一下。</p>
</blockquote>
<ul>
<li>工具<br />
<code>fdisk&amp;vim&amp;dumpe2fs&amp;dd&amp;/usr/include/linux/extn_fs.h</code></li>
</ul>
<h4 id="_4">操作</h4>
<ol>
<li>fdisk -l<br />
<code>得知文件系统在/dev/sda7</code></li>
<li>dd if=/dev/sda7 bs=1k(amount/per) skip=1(offset) count=1(times) of=superblock</li>
<li><code>vim superblock</code>+<code>:%! xxd</code><br />
<code>od -x superblock</code></li>
<li>再开一个终端dumpe2fs /dev/sda7 |grep "Inode count"</li>
<li>根据小端法阅读superblock对照Inode count</li>
</ol>
<p>结果</p>
<div class="hlcode"><pre><span class="mi">1</span> <span class="mo">00000000</span><span class="p">:</span> <span class="mo">0020</span> <span class="mi">7302</span> <span class="mo">0064</span> <span class="n">cc09</span> <span class="mi">666</span><span class="n">b</span> <span class="mi">7</span><span class="n">d00</span> <span class="mi">5726</span> <span class="mf">7e09</span>  <span class="o">.</span> <span class="n">s</span><span class="o">..</span><span class="n">d</span><span class="o">..</span><span class="n">fk</span><span class="p">}</span><span class="o">.</span><span class="n">W</span><span class="o">&amp;~.</span>
  <span class="mi">2</span> <span class="mo">00000010</span><span class="p">:</span> <span class="mi">8</span><span class="n">d4b</span> <span class="mf">6e02</span> <span class="mo">0000</span> <span class="mo">0000</span> <span class="mo">0200</span> <span class="mo">0000</span> <span class="mo">0200</span> <span class="mo">0000</span>  <span class="o">.</span><span class="n">Kn</span><span class="o">.............</span>
  <span class="mi">3</span> <span class="mo">00000020</span><span class="p">:</span> <span class="mo">00</span><span class="mi">80</span> <span class="mo">0000</span> <span class="mo">00</span><span class="mi">80</span> <span class="mo">0000</span> <span class="mo">0020</span> <span class="mo">0000</span> <span class="mi">8</span><span class="n">a6a</span> <span class="mi">7</span><span class="n">d5a</span>  <span class="o">.........</span> <span class="o">...</span><span class="n">j</span><span class="p">}</span><span class="n">Z</span>
  <span class="mi">4</span> <span class="mo">00000030</span><span class="p">:</span> <span class="mi">756</span><span class="n">a</span> <span class="mi">7</span><span class="n">d5a</span> <span class="mi">1</span><span class="n">b00</span> <span class="n">ffff</span> <span class="mi">53</span><span class="n">ef</span> <span class="mo">0100</span> <span class="mo">0100</span> <span class="mo">0000</span>  <span class="n">uj</span><span class="p">}</span><span class="n">Z</span><span class="o">....</span><span class="n">S</span><span class="o">.......</span>
  <span class="mi">5</span> <span class="mo">00000040</span><span class="p">:</span> <span class="mi">451</span><span class="n">d</span> <span class="mi">725</span><span class="n">a</span> <span class="mo">0000</span> <span class="mo">0000</span> <span class="mo">0000</span> <span class="mo">0000</span> <span class="mo">0100</span> <span class="mo">0000</span>  <span class="n">E</span><span class="o">.</span><span class="n">rZ</span><span class="o">............</span>
  <span class="mi">6</span> <span class="mo">00000050</span><span class="p">:</span> <span class="mo">0000</span> <span class="mo">0000</span> <span class="mi">0</span><span class="n">b00</span> <span class="mo">0000</span> <span class="mo">0001</span> <span class="mo">0000</span> <span class="mi">3</span><span class="n">c00</span> <span class="mo">0000</span>  <span class="o">............&lt;...</span>
  <span class="mi">7</span> <span class="mo">00000060</span><span class="p">:</span> <span class="mi">4602</span> <span class="mo">0000</span> <span class="mi">7</span><span class="n">b00</span> <span class="mo">0000</span> <span class="n">b70d</span> <span class="n">a271</span> <span class="mi">346</span><span class="n">b</span> <span class="mi">4</span><span class="n">ff6</span>  <span class="n">F</span><span class="o">...</span><span class="p">{</span><span class="o">......</span><span class="n">q4kO</span><span class="o">.</span>
  <span class="mi">8</span> <span class="mo">00000070</span><span class="p">:</span> <span class="mi">954</span><span class="n">b</span> <span class="n">cb93</span> <span class="mi">5</span><span class="n">b23</span> <span class="mi">9512</span> <span class="mo">0000</span> <span class="mo">0000</span> <span class="mo">0000</span> <span class="mo">0000</span>  <span class="o">.</span><span class="n">K</span><span class="o">..</span><span class="p">[</span><span class="c">#..........</span>
  <span class="mi">9</span> <span class="mo">000000</span><span class="mi">80</span><span class="p">:</span> <span class="mo">0000</span> <span class="mo">0000</span> <span class="mo">0000</span> <span class="mo">0000</span> <span class="mi">2</span><span class="n">f00</span> <span class="mi">6172</span> <span class="mi">6765</span> <span class="mi">7400</span>  <span class="o">......../.</span><span class="n">arget</span><span class="o">.</span>
 <span class="mi">10</span> <span class="mo">000000</span><span class="mi">90</span><span class="p">:</span> <span class="mo">0000</span> <span class="mo">0000</span> <span class="mo">0000</span> <span class="mo">0000</span> <span class="mo">0000</span> <span class="mo">0000</span> <span class="mo">0000</span> <span class="mo">0000</span>  <span class="o">................</span>
 <span class="mi">11</span> <span class="mo">000000</span><span class="n">a0</span><span class="p">:</span> <span class="mo">0000</span> <span class="mo">0000</span> <span class="mo">0000</span> <span class="mo">0000</span> <span class="mo">0000</span> <span class="mo">0000</span> <span class="mo">0000</span> <span class="mo">0000</span>  <span class="o">................</span>
 <span class="mi">12</span> <span class="mo">000000</span><span class="n">b0</span><span class="p">:</span> <span class="mo">0000</span> <span class="mo">0000</span> <span class="mo">0000</span> <span class="mo">0000</span> <span class="mo">0000</span> <span class="mo">0000</span> <span class="mo">0000</span> <span class="mo">0000</span>  <span class="o">................</span>
 <span class="mi">13</span> <span class="mo">000000</span><span class="n">c0</span><span class="p">:</span> <span class="mo">0000</span> <span class="mo">0000</span> <span class="mo">0000</span> <span class="mo">0000</span> <span class="mo">0000</span> <span class="mo">0000</span> <span class="mo">0000</span> <span class="n">d803</span>  <span class="o">................</span>
 <span class="mi">14</span> <span class="mo">000000</span><span class="n">d0</span><span class="p">:</span> <span class="mo">0000</span> <span class="mo">0000</span> <span class="mo">0000</span> <span class="mo">0000</span> <span class="mo">0000</span> <span class="mo">0000</span> <span class="mo">0000</span> <span class="mo">0000</span>  <span class="o">................</span>
 <span class="mi">15</span> <span class="mf">000000e0</span><span class="p">:</span> <span class="mi">0800</span> <span class="mo">0000</span> <span class="mo">0000</span> <span class="mo">0000</span> <span class="mi">9505</span> <span class="mo">0401</span> <span class="n">df82</span> <span class="n">d27e</span>  <span class="o">...............~</span>
 <span class="mi">16</span> <span class="mo">000000</span><span class="n">f0</span><span class="p">:</span> <span class="mo">0536</span> <span class="mi">4</span><span class="n">cce</span> <span class="mi">86</span><span class="n">b3</span> <span class="mi">2</span><span class="n">a8c</span> <span class="mi">0</span><span class="n">c06</span> <span class="mo">0730</span> <span class="mo">0101</span> <span class="mo">0000</span>  <span class="o">.</span><span class="il">6L</span><span class="o">...*....</span><span class="mf">0.</span><span class="o">...</span>
 <span class="mi">17</span> <span class="mo">00000100</span><span class="p">:</span> <span class="mi">0</span><span class="n">c00</span> <span class="mo">0000</span> <span class="mo">0000</span> <span class="mo">0000</span> <span class="mi">451</span><span class="n">d</span> <span class="mi">725</span><span class="n">a</span> <span class="mi">0</span><span class="n">af3</span> <span class="mo">0200</span>  <span class="o">........</span><span class="n">E</span><span class="o">.</span><span class="n">rZ</span><span class="o">....</span>
 <span class="mi">18</span> <span class="mo">00000110</span><span class="p">:</span> <span class="mo">0400</span> <span class="mo">0000</span> <span class="mo">0000</span> <span class="mo">0000</span> <span class="mo">0000</span> <span class="mo">0000</span> <span class="n">ff7f</span> <span class="mo">0000</span>  <span class="o">................</span>
 <span class="mi">19</span> <span class="mo">00000120</span><span class="p">:</span> <span class="mo">00</span><span class="mi">80</span> <span class="n">e004</span> <span class="n">ff7f</span> <span class="mo">0000</span> <span class="mo">0100</span> <span class="mo">0000</span> <span class="n">ffff</span> <span class="n">e004</span>  <span class="o">................</span>
 <span class="mi">20</span> <span class="mo">00000130</span><span class="p">:</span> <span class="mo">0000</span> <span class="mo">0000</span> <span class="mo">0000</span> <span class="mo">0000</span> <span class="mo">0000</span> <span class="mo">0000</span> <span class="mo">0000</span> <span class="mo">0000</span>  <span class="o">................</span>
 <span class="mi">21</span> <span class="mo">00000140</span><span class="p">:</span> <span class="mo">0000</span> <span class="mo">0000</span> <span class="mo">0000</span> <span class="mo">0000</span> <span class="mo">0000</span> <span class="mo">0000</span> <span class="mo">0000</span> <span class="mo">000</span><span class="mi">8</span>  <span class="o">................</span>
 <span class="mi">22</span> <span class="mo">00000150</span><span class="p">:</span> <span class="mo">0000</span> <span class="mo">0000</span> <span class="mo">0000</span> <span class="mo">0000</span> <span class="mo">0000</span> <span class="mo">0000</span> <span class="mi">1</span><span class="n">c00</span> <span class="mi">1</span><span class="n">c00</span>  <span class="o">................</span>
 <span class="mi">23</span> <span class="mo">00000160</span><span class="p">:</span> <span class="mo">0100</span> <span class="mo">0000</span> <span class="mo">0000</span> <span class="mo">0000</span> <span class="mo">0000</span> <span class="mo">0000</span> <span class="mo">0000</span> <span class="mo">0000</span>  <span class="o">................</span>
</pre></div>


<p>0020 7302小端阅读 02732000(16)=&gt;41099264(10)</p>
<p>dumpe2fs结果</p>
<div class="hlcode"><pre><span class="n">dumpe2fs</span> <span class="mf">1.42.13</span> <span class="p">(</span><span class="mi">17</span><span class="o">-</span><span class="n">May</span><span class="o">-</span><span class="mi">2015</span><span class="p">)</span>
<span class="n">Inode</span> <span class="n">count</span><span class="o">:</span>              <span class="mi">41099264</span>
</pre></div>


<p>ok!<br />
自行对应数据结构</p>
  <div id="comments"></div>
  <link rel="stylesheet" href="https://imsun.github.io/gitment/style/default.css">
  <script src="https://imsun.github.io/gitment/dist/gitment.browser.js"></script>
  <script type="text/javascript">
  const gitment = new Gitment({
    title: '文件系统原理',
    owner: 'srcagile',
    repo: 'wiki',
    oauth: {
      client_id: '8d3768fea78397a633b8',
      client_secret: 'a79297700926ce00af68c66bc8ad1b06e6389cc0',
    },
    // ...
    // For more available options, check out the documentation below
  })
  gitment.render('comments')
  // or
  // gitment.render(document.getElementById('comments'))
  // or
  // document.body.appendChild(gitment.render())
  </script>
    </div>
    <div id="footer">
      <span>
        <p>Copyright © 2018 Guozhen Li.
          <a href='https://github.com/srcagile/wiki' style="color:red">Fork me on GitHub</a>
          <span id="cnzz_stat_icon_1256629854">
            <a href="http://www.cnzz.com/stat/website.php?web_id=1256629854" target="_blank" title="站长统计">
              <img border="0" hspace="0" vspace="0" src="http://icon.cnzz.com/img/pic.gif">
            </a>
          </span>
       </p>
        <p>Site Generated 2018-02-18 22:49:45</p>
      </span>
    </div>

    
    
  </body>

</html>